--- prev/cms.c	2018-08-14 22:48:56.000000000 +1000
+++ apps/cms.c	2021-01-22 16:13:14.467425833 +1000
@@ -70,6 +70,7 @@
 # undef PROG
 # define PROG cms_main
 static int save_certs(char *signerfile, STACK_OF(X509) *signers);
+static int save_crls(char *crlfile, STACK_OF(X509_CRL) *crls);
 static int cms_cb(int ok, X509_STORE_CTX *ctx);
 static void receipt_request_print(BIO *out, CMS_ContentInfo *cms);
 static CMS_ReceiptRequest *make_receipt_request(STACK_OF(OPENSSL_STRING)
@@ -119,9 +120,11 @@
     const char *inmode = "r", *outmode = "w";
     char *infile = NULL, *outfile = NULL, *rctfile = NULL;
     char *signerfile = NULL, *recipfile = NULL;
+    char *crlfile = NULL;
     STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
     char *certfile = NULL, *keyfile = NULL, *contfile = NULL;
     char *certsoutfile = NULL;
+    char *crlsoutfile = NULL;
     const EVP_CIPHER *cipher = NULL, *wrap_cipher = NULL;
     CMS_ContentInfo *cms = NULL, *rcms = NULL;
     X509_STORE *store = NULL;
@@ -411,6 +414,10 @@
             if (!args[1])
                 goto argerr;
             certsoutfile = *++args;
+        } else if (!strcmp(*args, "-crlsout")) {
+            if (!args[1])
+                goto argerr;
+            crlsoutfile = *++args;
         } else if (!strcmp(*args, "-md")) {
             if (!args[1])
                 goto argerr;
@@ -483,6 +490,10 @@
             if (!args[1])
                 goto argerr;
             certfile = *++args;
+        } else if (!strcmp(*args, "-CRLfile")) {
+            if (!args[1])
+                goto argerr;
+            crlfile = *++args;
         } else if (!strcmp(*args, "-CAfile")) {
             if (!args[1])
                 goto argerr;
@@ -807,6 +818,17 @@
             }
             sk_X509_pop_free(allcerts, X509_free);
         }
+        if (crlsoutfile) {
+            STACK_OF(X509_CRL) *allcrls;
+            allcrls = CMS_get1_crls(cms);
+            if (!save_crls(crlsoutfile, allcrls)) {
+                BIO_printf(bio_err,
+                           "Error writing certs to %s\n", crlsoutfile);
+                ret = 5;
+                goto end;
+            }
+            sk_X509_CRL_pop_free(allcrls, X509_CRL_free);
+        }
     }
 
     if (rctfile) {
@@ -968,6 +990,22 @@
             }
         } else
             flags |= CMS_REUSE_DIGEST;
+
+        if ((operation == SMIME_SIGN) || (operation == SMIME_RESIGN)) {
+            if (crlfile) {
+                STACK_OF(X509_CRL) *crls = load_crls(
+                    bio_err, crlfile, FORMAT_PEM, NULL,
+                    e, "CRL file");
+                if (!crls) {
+                    exit(1);
+                }
+                for (int i = 0; i < sk_X509_CRL_num(crls); i++) {
+                    X509_CRL *item = sk_X509_CRL_value(crls, i);
+                    CMS_add1_crl(cms, item);
+                }
+            }
+        }
+
         for (i = 0; i < sk_OPENSSL_STRING_num(sksigners); i++) {
             CMS_SignerInfo *si;
             cms_key_param *kparam;
@@ -1071,6 +1109,19 @@
                                        indata, out, flags))
             goto end;
     } else if (operation == SMIME_VERIFY) {
+	if (crlfile) {
+	    STACK_OF(X509_CRL) *crls = load_crls(
+		bio_err, crlfile, FORMAT_PEM, NULL,
+		e, "CRL file");
+	    if (!crls) {
+		exit(1);
+	    }
+	    for (int i = 0; i < sk_X509_CRL_num(crls); i++) {
+		X509_CRL *item = sk_X509_CRL_value(crls, i);
+		CMS_add1_crl(cms, item);
+	    }
+	}
+
         if (CMS_verify(cms, other, store, indata, out, flags) > 0)
             BIO_printf(bio_err, "Verification successful\n");
         else {
@@ -1194,6 +1245,21 @@
     BIO_free(tmp);
     return 1;
 }
+
+static int save_crls(char *crlfile, STACK_OF(X509_CRL) *crls)
+{
+    int i;
+    BIO *tmp;
+    if (!crlfile)
+        return 1;
+    tmp = BIO_new_file(crlfile, "w");
+    if (!tmp)
+        return 0;
+    for (i = 0; i < sk_X509_CRL_num(crls); i++)
+        PEM_write_bio_X509_CRL(tmp, sk_X509_CRL_value(crls, i));
+    BIO_free(tmp);
+    return 1;
+}
 
 /* Minimal callback just to output policy info (if any) */
 
